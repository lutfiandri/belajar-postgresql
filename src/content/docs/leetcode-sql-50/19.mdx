---
title: Queries Quality and Percentage
description: Queries Quality and Percentage
---

import { Badge } from "@astrojs/starlight/components";

<Badge text="Easy" variant="note" />
<Badge text="Basic Aggregate Functions" variant="note" />

Hitung quality dan poor query percentage untuk setiap query menggunakan `AVG()`, `COUNT()`, `FILTER`, dan `GROUP BY`.

https://leetcode.com/problems/queries-quality-and-percentage

## Soal

> Table: `Queries`
>
> ```
> +-------------+---------+
> | Column Name | Type    |
> +-------------+---------+
> | query_name  | varchar |
> | result      | varchar |
> | position    | int     |
> | rating      | int     |
> +-------------+---------+
> ```
>
> This table may have duplicate rows.
>
> This table contains information collected from some queries on a database.
>
> The `position` column has a value from 1 to 500.
>
> The `rating` column has a value from 1 to 5. Query with rating less than 3 is a poor query.

We define query `quality` as:

> The average of the ratio between query rating and its position.

We also define `poor query percentage` as:

> The percentage of all queries with rating less than 3.

Write a solution to find each `query_name`, the `quality` and `poor_query_percentage`.

Both `quality` and `poor_query_percentage` should be rounded to 2 decimal places.

Return the result table in any order.

The result format is in the following example.

> **Example 1:**
>
> Input:
>
> `Queries` table:
>
> ```
> +------------+-------------------+----------+--------+
> | query_name | result            | position | rating |
> +------------+-------------------+----------+--------+
> | Dog        | Golden Retriever  | 1        | 5      |
> | Dog        | German Shepherd   | 2        | 5      |
> | Dog        | Mule              | 200      | 1      |
> | Cat        | Shirazi           | 5        | 2      |
> | Cat        | Siamese           | 3        | 3      |
> | Cat        | Sphynx            | 7        | 4      |
> +------------+-------------------+----------+--------+
> ```
>
> Output:
>
> ```
> +------------+---------+-----------------------+
> | query_name | quality | poor_query_percentage |
> +------------+---------+-----------------------+
> | Dog        | 2.50    | 33.33                 |
> | Cat        | 0.66    | 33.33                 |
> +------------+---------+-----------------------+
> ```
>
> **Explanation:**
>
> - Dog queries quality is ((5 / 1) + (5 / 2) + (1 / 200)) / 3 = 2.50
> - Dog queries poor_query_percentage is (1 / 3) * 100 = 33.33
> - Cat queries quality equals ((2 / 5) + (3 / 3) + (4 / 7)) / 3 = 0.66
> - Cat queries poor_query_percentage is (1 / 3) * 100 = 33.33

## Setup Soal

Buat tabel dan insert data contoh:

```sql
CREATE TABLE Queries (
    query_name VARCHAR(100),
    result VARCHAR(100),
    position INT,
    rating INT
);

INSERT INTO Queries (query_name, result, position, rating) VALUES
    ('Dog', 'Golden Retriever', 1, 5),
    ('Dog', 'German Shepherd', 2, 5),
    ('Dog', 'Mule', 200, 1),
    ('Cat', 'Shirazi', 5, 2),
    ('Cat', 'Siamese', 3, 3),
    ('Cat', 'Sphynx', 7, 4);
```

## Jawaban SQL

```sql "FILTER (WHERE rating < 3)"
SELECT 
    query_name,
    ROUND(AVG(rating::NUMERIC / position), 2) AS quality,
    ROUND(COUNT(*) FILTER (WHERE rating < 3) * 100.0 / COUNT(*), 2) AS poor_query_percentage
FROM Queries
WHERE query_name IS NOT NULL
GROUP BY query_name;
```

## Penjelasan

Soal ini meminta kita menghitung dua metrik untuk setiap query:

1. **Quality**: Rata-rata dari rasio `rating / position`
2. **Poor Query Percentage**: Persentase query dengan `rating < 3`

Mari kita breakdown query-nya step by step:

1. **FROM Queries**: Ambil data dari tabel `Queries`.

   Isi tabel `Queries`:

   ```
   +------------+-------------------+----------+--------+
   | query_name | result            | position | rating |
   +------------+-------------------+----------+--------+
   | Dog        | Golden Retriever  | 1        | 5      |
   | Dog        | German Shepherd   | 2        | 5      |
   | Dog        | Mule              | 200      | 1      |
   | Cat        | Shirazi           | 5        | 2      |
   | Cat        | Siamese           | 3        | 3      |
   | Cat        | Sphynx            | 7        | 4      |
   +------------+-------------------+----------+--------+
   ```

2. **WHERE query_name IS NOT NULL**: Filter hanya baris yang punya `query_name` (tidak NULL).

   Karena soal menyebutkan tabel bisa punya duplicate rows dan tidak ada constraint, kita perlu memastikan `query_name` tidak NULL untuk keamanan.

3. **GROUP BY query_name**: Kelompokkan data berdasarkan `query_name`.

   Setelah dikelompokkan:
   - Dog: 3 queries (Golden Retriever, German Shepherd, Mule)
   - Cat: 3 queries (Shirazi, Siamese, Sphynx)

4. **Menghitung Quality**: `AVG(rating::NUMERIC / position)`

   Quality adalah rata-rata dari `rating / position` untuk setiap query.

   **Dog**:
   - Query 1: `5 / 1 = 5.0`
   - Query 2: `5 / 2 = 2.5`
   - Query 3: `1 / 200 = 0.005`
   - Quality: `AVG(5.0, 2.5, 0.005) = (5.0 + 2.5 + 0.005) / 3 = 7.505 / 3 = 2.501666...`

   **Cat**:
   - Query 1: `2 / 5 = 0.4`
   - Query 2: `3 / 3 = 1.0`
   - Query 3: `4 / 7 = 0.571428...`
   - Quality: `AVG(0.4, 1.0, 0.571428...) = (0.4 + 1.0 + 0.571428...) / 3 = 1.971428... / 3 = 0.657142...`

   Kenapa pakai `rating::NUMERIC`?

   - Tanpa cast, `rating` (integer) dibagi `position` (integer) akan menghasilkan integer division. Contoh: `5 / 2 = 2` (bukan `2.5`).
   - Dengan `::NUMERIC`, kita memaksa PostgreSQL melakukan pembagian decimal untuk mendapat hasil yang akurat.

5. **Menghitung Poor Query Percentage**: `COUNT(*) FILTER (WHERE rating < 3) * 100.0 / COUNT(*)`

   Poor query adalah query dengan `rating < 3`.

   **Dog**:
   - Total queries: 3
   - Poor queries (rating < 3): 1 (Mule dengan rating 1)
   - Percentage: `1 * 100.0 / 3 = 33.333...`

   **Cat**:
   - Total queries: 3
   - Poor queries (rating < 3): 1 (Shirazi dengan rating 2)
   - Percentage: `1 * 100.0 / 3 = 33.333...`

   Apa itu `FILTER`?

   - `COUNT(*) FILTER (WHERE rating < 3)` adalah cara PostgreSQL untuk menghitung baris yang memenuhi kondisi tertentu.
   - Ini sama dengan `SUM(CASE WHEN rating < 3 THEN 1 ELSE 0 END)`, tapi lebih ringkas dan mudah dibaca.

6. **ROUND(..., 2)**: Membulatkan kedua hasil ke 2 desimal.

   - Dog quality: `2.50`
   - Dog poor_query_percentage: `33.33`
   - Cat quality: `0.66`
   - Cat poor_query_percentage: `33.33`

Hasil akhir:

```
+------------+---------+-----------------------+
| query_name | quality | poor_query_percentage |
+------------+---------+-----------------------+
| Dog        | 2.50    | 33.33                 |
| Cat        | 0.66    | 33.33                 |
+------------+---------+-----------------------+
```

## Referensi

- `SELECT`: Memilih kolom yang akan ditampilkan.
- `FROM`: Menentukan tabel sumber data.
- `WHERE`: Memfilter baris berdasarkan kondisi.
- `GROUP BY`: Mengelompokkan baris berdasarkan nilai kolom tertentu.
- `AVG()`: Menghitung rata-rata nilai dalam setiap grup.
- `COUNT()`: Menghitung jumlah baris.
- `FILTER (WHERE ...)`: Menerapkan kondisi filter pada fungsi agregat (PostgreSQL specific).
- `ROUND(value, decimal_places)`: Membulatkan nilai ke jumlah desimal tertentu.
- `::NUMERIC`: Cast value ke tipe data `NUMERIC` untuk pembagian decimal yang akurat.
- `IS NOT NULL`: Memeriksa apakah nilai tidak NULL.
- `AS`: Memberi alias untuk kolom hasil query.
- Integer Division vs Decimal Division: Pembagian integer menghasilkan integer, gunakan cast ke NUMERIC/FLOAT untuk hasil decimal.
- [Tipe Data Angka](../../basic/01-01-number-types)
