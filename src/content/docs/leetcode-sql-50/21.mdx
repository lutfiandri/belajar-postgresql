---
title: Immediate Food Delivery II
description: Immediate Food Delivery II
---

import { Badge } from "@astrojs/starlight/components";

<Badge text="Medium" variant="note" />
<Badge text="Basic Aggregate Functions" variant="note" />

Hitung persentase immediate order pada first order setiap customer menggunakan CTE, `DISTINCT ON`, dan `AVG()` dengan boolean cast.

https://leetcode.com/problems/immediate-food-delivery-ii

## Soal

> Table: `Delivery`
>
> ```
> +-----------------------------+---------+
> | Column Name                 | Type    |
> +-----------------------------+---------+
> | delivery_id                 | int     |
> | customer_id                 | int     |
> | order_date                  | date    |
> | customer_pref_delivery_date | date    |
> +-----------------------------+---------+
> ```
>
> `delivery_id` is the column of unique values of this table.
>
> The table holds information about food delivery to customers that make orders at some date and specify a preferred delivery date (on the same order date or after it).

If the customer's preferred delivery date is the same as the order date, then the order is called **immediate**; otherwise, it is called **scheduled**.

The **first order** of a customer is the order with the earliest order date that the customer made. It is guaranteed that a customer has precisely one first order.

Write a solution to find the percentage of immediate orders in the first orders of all customers, rounded to 2 decimal places.

The result format is in the following example.

> **Example 1:**
>
> Input:
>
> `Delivery` table:
>
> ```
> +-------------+-------------+------------+-----------------------------+
> | delivery_id | customer_id | order_date | customer_pref_delivery_date |
> +-------------+-------------+------------+-----------------------------+
> | 1           | 1           | 2019-08-01 | 2019-08-02                  |
> | 2           | 2           | 2019-08-02 | 2019-08-02                  |
> | 3           | 1           | 2019-08-11 | 2019-08-12                  |
> | 4           | 3           | 2019-08-24 | 2019-08-24                  |
> | 5           | 3           | 2019-08-21 | 2019-08-22                  |
> | 6           | 2           | 2019-08-11 | 2019-08-13                  |
> | 7           | 4           | 2019-08-09 | 2019-08-09                  |
> +-------------+-------------+------------+-----------------------------+
> ```
>
> Output:
>
> ```
> +----------------------+
> | immediate_percentage |
> +----------------------+
> | 50.00                |
> +----------------------+
> ```
>
> **Explanation:**
>
> - The customer id 1 has a first order with delivery id 1 and it is scheduled.
> - The customer id 2 has a first order with delivery id 2 and it is immediate.
> - The customer id 3 has a first order with delivery id 5 and it is scheduled.
> - The customer id 4 has a first order with delivery id 7 and it is immediate.
> - Hence, half the customers have immediate first orders.

## Setup Soal

Buat tabel dan insert data contoh:

```sql
CREATE TABLE Delivery (
    delivery_id INT PRIMARY KEY,
    customer_id INT,
    order_date DATE,
    customer_pref_delivery_date DATE
);

INSERT INTO Delivery (delivery_id, customer_id, order_date, customer_pref_delivery_date) VALUES
    (1, 1, '2019-08-01', '2019-08-02'),
    (2, 2, '2019-08-02', '2019-08-02'),
    (3, 1, '2019-08-11', '2019-08-12'),
    (4, 3, '2019-08-24', '2019-08-24'),
    (5, 3, '2019-08-21', '2019-08-22'),
    (6, 2, '2019-08-11', '2019-08-13'),
    (7, 4, '2019-08-09', '2019-08-09');
```

## Jawaban SQL

```sql "WITH first_delivery AS" "DISTINCT ON (customer_id)" "(order_date = customer_pref_delivery_date)::int"
WITH first_delivery AS (
    SELECT DISTINCT ON (customer_id)
        order_date,
        customer_pref_delivery_date
    FROM Delivery
    ORDER BY customer_id, order_date
)
SELECT 
    ROUND(
        AVG((order_date = customer_pref_delivery_date)::INT) * 100, 
        2
    ) AS immediate_percentage
FROM first_delivery;
```

## Penjelasan

Soal ini meminta kita menghitung persentase **first order** yang **immediate** dari semua customer.

- **First order**: Order pertama customer (order_date paling awal)
- **Immediate order**: Order dengan `order_date = customer_pref_delivery_date`

Untuk menyelesaikan soal ini, kita perlu:
1. Ambil first order setiap customer
2. Hitung persentase order yang immediate

:::note[CTE (Common Table Expression)]
Meskipun soal ini masih masuk kategori "Basic Aggregate Functions", kita akan menggunakan **CTE** (Common Table Expression) untuk mempermudah pengerjaan.

CTE adalah semacam **tabel sementara** yang bisa kita buat untuk membantu query utama. CTE ditulis dengan syntax `WITH nama_cte AS (query)`.

CTE sangat berguna untuk memecah query kompleks menjadi bagian-bagian yang lebih mudah dipahami.
:::

Mari kita breakdown query-nya step by step:

### Langkah 1: Ambil First Order Setiap Customer (CTE)

```sql
WITH first_delivery AS (
    SELECT DISTINCT ON (customer_id)
        order_date,
        customer_pref_delivery_date
    FROM Delivery
    ORDER BY customer_id, order_date
)
```

**DISTINCT ON (customer_id)** adalah fitur PostgreSQL yang sangat powerful untuk mengambil 1 baris pertama dari setiap grup.

- `DISTINCT ON (customer_id)`: Ambil 1 baris unik per `customer_id`
- `ORDER BY customer_id, order_date`: Urutkan berdasarkan `customer_id`, lalu `order_date` (ascending)

Karena diurutkan berdasarkan `order_date` ascending, `DISTINCT ON` akan mengambil baris dengan `order_date` paling awal untuk setiap customer.

Hasil CTE `first_delivery`:

```
+-------------+------------+-----------------------------+
| customer_id | order_date | customer_pref_delivery_date |
+-------------+------------+-----------------------------+
| 1           | 2019-08-01 | 2019-08-02                  | ← scheduled
| 2           | 2019-08-02 | 2019-08-02                  | ← immediate
| 3           | 2019-08-21 | 2019-08-22                  | ← scheduled
| 4           | 2019-08-09 | 2019-08-09                  | ← immediate
+-------------+------------+-----------------------------+
```

Penjelasan:
- Customer 1: First order tanggal 2019-08-01 (bukan 2019-08-11)
- Customer 2: First order tanggal 2019-08-02 (bukan 2019-08-11)
- Customer 3: First order tanggal 2019-08-21 (bukan 2019-08-24)
- Customer 4: First order tanggal 2019-08-09

### Langkah 2: Hitung Persentase Immediate Order

```sql
SELECT 
    ROUND(
        AVG((order_date = customer_pref_delivery_date)::INT) * 100, 
        2
    ) AS immediate_percentage
FROM first_delivery;
```

**Cast Boolean ke Integer**: `(order_date = customer_pref_delivery_date)::INT`

- `order_date = customer_pref_delivery_date` menghasilkan boolean (`TRUE` atau `FALSE`)
- `::INT` mengubah boolean menjadi integer:
  - `TRUE` → `1`
  - `FALSE` → `0`

Mari kita hitung manual:

| customer_id | order_date = customer_pref_delivery_date | Cast to INT |
|-------------|------------------------------------------|-------------|
| 1           | FALSE (2019-08-01 ≠ 2019-08-02)          | 0           |
| 2           | TRUE (2019-08-02 = 2019-08-02)           | 1           |
| 3           | FALSE (2019-08-21 ≠ 2019-08-22)          | 0           |
| 4           | TRUE (2019-08-09 = 2019-08-09)           | 1           |

**AVG()**: Menghitung rata-rata dari 0 dan 1.

```
AVG(0, 1, 0, 1) = (0 + 1 + 0 + 1) / 4 = 2 / 4 = 0.5
```

**Kalikan 100**: `0.5 * 100 = 50.0`

**ROUND(..., 2)**: Bulatkan ke 2 desimal → `50.00`

Hasil akhir:

```
+----------------------+
| immediate_percentage |
+----------------------+
| 50.00                |
+----------------------+
```

Jadi, 50% dari first order semua customer adalah immediate order.

## Referensi

- `WITH ... AS (...)`: Membuat CTE (Common Table Expression) sebagai tabel sementara.
- `SELECT`: Memilih kolom yang akan ditampilkan.
- `FROM`: Menentukan tabel sumber data.
- `DISTINCT ON (column)`: Mengambil 1 baris unik pertama untuk setiap nilai kolom tertentu (PostgreSQL specific).
- `ORDER BY`: Mengurutkan hasil berdasarkan kolom tertentu.
- `AVG()`: Menghitung rata-rata nilai.
- `ROUND(value, decimal_places)`: Membulatkan nilai ke jumlah desimal tertentu.
- `::INT`: Cast value ke tipe data integer.
- Boolean Cast: Boolean `TRUE` menjadi `1`, `FALSE` menjadi `0` saat di-cast ke integer.
- `AS`: Memberi alias untuk kolom hasil query.
- CTE: Tabel sementara yang membantu memecah query kompleks menjadi lebih mudah dipahami.
- [Tipe Data Tanggal dan Waktu](../../basic/01-03-date-time-types)
