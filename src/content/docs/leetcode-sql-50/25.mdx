---
title: Product Sales Analysis III
description: Product Sales Analysis III
---

import { Badge } from "@astrojs/starlight/components";

<Badge text="Medium" variant="note" />
<Badge text="Sorting and Grouping" variant="note" />

Temukan semua penjualan yang terjadi di tahun pertama setiap produk dijual menggunakan `DISTINCT ON` dan `ORDER BY`.

https://leetcode.com/problems/product-sales-analysis-iii

## Soal

> Table: `Sales`
>
> ```
> +-------------+-------+
> | Column Name | Type  |
> +-------------+-------+
> | sale_id     | int   |
> | product_id  | int   |
> | year        | int   |
> | quantity    | int   |
> | price       | int   |
> +-------------+-------+
> ```
>
> (`sale_id`, `year`) is the primary key (combination of columns with unique values) of this table.
>
> Each row records a sale of a product in a given year.
>
> A product may have multiple sales entries in the same year.
>
> Note that the `price` is the per-unit price.

Write a solution to find all sales that occurred in the first year each product was sold.

- For each `product_id`, identify the earliest year it appears in the Sales table.
- Return all sales entries for that product in that year.

Return a table with the following columns: `product_id`, `first_year`, `quantity`, and `price`.

Return the result in any order.

> **Example 1:**
>
> Input:
>
> `Sales` table:
>
> ```
> +---------+------------+------+----------+-------+
> | sale_id | product_id | year | quantity | price |
> +---------+------------+------+----------+-------+ 
> | 1       | 100        | 2008 | 10       | 5000  |
> | 2       | 100        | 2009 | 12       | 5000  |
> | 7       | 200        | 2011 | 15       | 9000  |
> +---------+------------+------+----------+-------+
> ```
>
> Output:
>
> ```
> +------------+------------+----------+-------+
> | product_id | first_year | quantity | price |
> +------------+------------+----------+-------+ 
> | 100        | 2008       | 10       | 5000  |
> | 200        | 2011       | 15       | 9000  |
> +------------+------------+----------+-------+
> ```

## Setup Soal

Buat tabel dan insert data contoh:

```sql
CREATE TABLE Sales (
    sale_id INT,
    product_id INT,
    year INT,
    quantity INT,
    price INT,
    PRIMARY KEY (sale_id, year)
);

INSERT INTO Sales (sale_id, product_id, year, quantity, price) VALUES
    (1, 100, 2008, 10, 5000),
    (2, 100, 2009, 12, 5000),
    (7, 200, 2011, 15, 9000);
```

## Jawaban SQL

```sql "WITH sales_first_year AS" "MIN(year)" "JOIN"
WITH sales_first_year AS (
    SELECT 
        product_id,
        MIN(year) AS first_year
    FROM Sales
    GROUP BY product_id
)
SELECT
    s.product_id,
    sfy.first_year,
    s.quantity,
    s.price
FROM sales_first_year sfy
JOIN Sales s 
    ON sfy.first_year = s.year
    AND sfy.product_id = s.product_id;
```

## Penjelasan

Soal ini meminta kita untuk menemukan **semua penjualan di tahun pertama** setiap produk dijual.

Penting untuk dipahami: Jika sebuah produk punya **beberapa penjualan di tahun pertama yang sama**, kita harus mengembalikan **semua penjualan tersebut**.

Untuk setiap produk:
1. Cari tahun pertama produk tersebut dijual (year paling kecil)
2. Ambil **semua** data penjualan di tahun pertama tersebut

Mari kita breakdown query-nya step by step:

### Langkah 1: Temukan First Year Setiap Product (CTE)

```sql
WITH sales_first_year AS (
    SELECT 
        product_id,
        MIN(year) AS first_year
    FROM Sales
    GROUP BY product_id
)
```

**GROUP BY product_id**: Kelompokkan data berdasarkan `product_id`.

**MIN(year)**: Ambil tahun terkecil (tahun pertama) untuk setiap produk.

Hasil CTE `sales_first_year`:

```
+------------+------------+
| product_id | first_year |
+------------+------------+
| 100        | 2008       |
| 200        | 2011       |
+------------+------------+
```

- Product 100 pertama kali dijual di tahun 2008
- Product 200 pertama kali dijual di tahun 2011

### Langkah 2: Join dengan Tabel Sales

```sql
SELECT
    s.product_id,
    sfy.first_year,
    s.quantity,
    s.price
FROM sales_first_year sfy
JOIN Sales s 
    ON sfy.first_year = s.year
    AND sfy.product_id = s.product_id;
```

**JOIN dengan 2 Kondisi**:
- `sfy.product_id = s.product_id`: Match product yang sama
- `sfy.first_year = s.year`: Match hanya penjualan di tahun pertama

Mari kita lihat proses JOIN-nya:

**Tabel sales_first_year**:

```
+------------+------------+
| product_id | first_year |
+------------+------------+
| 100        | 2008       |
| 200        | 2011       |
+------------+------------+
```

**Tabel Sales**:

```
+---------+------------+------+----------+-------+
| sale_id | product_id | year | quantity | price |
+---------+------------+------+----------+-------+ 
| 1       | 100        | 2008 | 10       | 5000  |
| 2       | 100        | 2009 | 12       | 5000  |
| 7       | 200        | 2011 | 15       | 9000  |
+---------+------------+------+----------+-------+
```

**Proses JOIN**:
- Product 100, first_year 2008 → Match dengan sale_id 1 (product 100, year 2008) ✓
- Product 100, first_year 2008 → Tidak match dengan sale_id 2 (product 100, year 2009) ✗
- Product 200, first_year 2011 → Match dengan sale_id 7 (product 200, year 2011) ✓

Hasil akhir:

```
+------------+------------+----------+-------+
| product_id | first_year | quantity | price |
+------------+------------+----------+-------+ 
| 100        | 2008       | 10       | 5000  |
| 200        | 2011       | 15       | 9000  |
+------------+------------+----------+-------+
```

### Kenapa Tidak Pakai DISTINCT ON?

Sebenarnya `DISTINCT ON` bisa dipakai untuk soal ini karena di contoh setiap produk hanya punya 1 penjualan di tahun pertama. Tapi **jika ada beberapa penjualan di tahun pertama yang sama**, `DISTINCT ON` akan gagal karena hanya mengambil 1 baris pertama.

Contoh kasus:

```
+---------+------------+------+----------+-------+
| sale_id | product_id | year | quantity | price |
+---------+------------+------+----------+-------+ 
| 1       | 100        | 2008 | 10       | 5000  |
| 8       | 100        | 2008 | 20       | 4500  | ← Penjualan kedua di tahun pertama!
| 2       | 100        | 2009 | 12       | 5000  |
+---------+------------+------+----------+-------+
```

Dalam kasus ini:
- **DISTINCT ON**: Hanya ambil 1 baris (sale_id 1) ❌
- **JOIN dengan CTE**: Ambil semua baris di tahun 2008 (sale_id 1 dan 8) ✓

Oleh karena itu, pendekatan dengan CTE + JOIN lebih aman dan sesuai dengan requirement soal.

## Referensi

- `WITH ... AS (...)`: Membuat CTE (Common Table Expression) sebagai tabel sementara.
- `SELECT`: Memilih kolom yang akan ditampilkan.
- `FROM`: Menentukan tabel sumber data.
- `JOIN`: Menggabungkan dua tabel berdasarkan kondisi tertentu.
- `ON`: Menentukan kondisi untuk menggabungkan baris dari kedua tabel.
- Multiple Join Conditions: Menggunakan `AND` untuk menambahkan lebih dari 1 kondisi JOIN.
- `GROUP BY`: Mengelompokkan baris berdasarkan nilai kolom tertentu.
- `MIN()`: Mengembalikan nilai terkecil dalam setiap grup.
- `AS`: Memberi alias untuk kolom hasil query.
- Primary Key Komposit: Primary key yang terdiri dari kombinasi beberapa kolom.
- [Memahami 4 Jenis JOIN](../../basic/02-01-4-joins)
